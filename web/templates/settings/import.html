{% extends "settings/index.html" %}

{% block settings_content %}
<div class="card">
    <div class="card-header">
        <i data-lucide="package"></i>
        <h2>Import Data</h2>
    </div>
    <div class="card-body">
        <p class="description" style="margin-bottom: 1.5rem;">
            Import configuration and tracking data from a CLI installation of PlexCache-R.
        </p>

        <!-- Import folder location -->
        <div class="alert" style="margin-bottom: 1.5rem; background: rgba(255, 255, 255, 0.05);">
            <i data-lucide="folder" style="color: var(--plex-text-muted);"></i>
            <div>
                <strong>Import Location</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--plex-text-muted);">
                    Place your CLI files in <code>/config/import/</code>
                </p>
            </div>
        </div>

        <!-- Import status section -->
        <div id="import-status">
            <!-- Checking for files -->
            <div id="import-checking" style="text-align: center; padding: 2rem;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p class="text-muted">Checking for import files...</p>
            </div>

            <!-- No files found -->
            <div id="import-not-found" style="display: none;">
                <div style="background: var(--surface-secondary); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; color: var(--plex-text-muted); margin-bottom: 1rem; display: block; margin: 0 auto 1rem;"></i>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">No Import Files Detected</h3>
                    <p style="margin: 0; color: var(--plex-text-muted); font-size: 0.9rem;">
                        To import data from CLI version, place these files in <code>/config/import/</code>:
                    </p>
                    <ul style="text-align: left; max-width: 400px; margin: 1rem auto 0; padding-left: 1.5rem; color: var(--plex-text-muted); font-size: 0.9rem;">
                        <li><code>plexcache_settings.json</code> - Configuration file</li>
                        <li><code>data/</code> folder containing:
                            <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                <li><code>timestamps.json</code></li>
                                <li><code>ondeck_tracker.json</code></li>
                                <li><code>watchlist_tracker.json</code></li>
                                <li><code>user_tokens.json</code></li>
                            </ul>
                        </li>
                    </ul>
                    <button type="button" class="btn btn-secondary" style="margin-top: 1rem;" onclick="checkForImportFiles()">
                        <i data-lucide="refresh-cw"></i>
                        Check Again
                    </button>
                </div>
            </div>

            <!-- Files found -->
            <div id="import-found" style="display: none;">
                <div class="alert alert-success" style="margin-bottom: 1rem;">
                    <i data-lucide="check-circle"></i>
                    <span>Import files detected!</span>
                </div>

                <!-- Summary -->
                <div style="background: var(--surface-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.75rem 0; font-size: 0.95rem; color: var(--plex-text-muted);">Files Found</h4>
                    <div id="import-summary" style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Path conversion settings -->
                <div style="background: var(--surface-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.75rem 0; font-size: 0.95rem; color: var(--plex-text-muted);">Path Conversion</h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: var(--plex-text-muted);">
                        Cache paths in your CLI data will be converted to Docker container paths.
                    </p>

                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="cli_cache_prefix">CLI Cache Path Prefix</label>
                        <input type="text" id="cli_cache_prefix" name="cli_cache_prefix"
                               value="/mnt/cache_downloads/"
                               placeholder="/mnt/cache_downloads/">
                        <p class="help-text">The cache path used in your CLI installation</p>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="docker_cache_prefix">Docker Cache Path</label>
                        <input type="text" id="docker_cache_prefix" name="docker_cache_prefix"
                               value="/mnt/cache/"
                               placeholder="/mnt/cache/">
                        <p class="help-text">The cache path in your Docker container (usually /mnt/cache/)</p>
                    </div>
                </div>

                <!-- Import options -->
                <div style="background: var(--surface-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.75rem 0; font-size: 0.95rem; color: var(--plex-text-muted);">Import Options</h4>
                    <label class="checkbox-item" style="background: none; padding: 0.5rem 0;">
                        <input type="checkbox" id="import_settings" checked>
                        <div class="checkbox-label">
                            <strong>Import Settings</strong>
                            <span>Plex connection, libraries, users, behavior settings</span>
                        </div>
                    </label>
                    <label class="checkbox-item" style="background: none; padding: 0.5rem 0;">
                        <input type="checkbox" id="import_data" checked>
                        <div class="checkbox-label">
                            <strong>Import Tracking Data</strong>
                            <span>Timestamps, OnDeck items, Watchlist items</span>
                        </div>
                    </label>
                </div>

                <!-- Warning -->
                <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                    <i data-lucide="alert-triangle"></i>
                    <div>
                        <strong>Warning</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                            Importing will overwrite your current configuration and data files.
                            Make sure you have a backup if needed.
                        </p>
                    </div>
                </div>

                <!-- Action buttons -->
                <div style="display: flex; gap: 0.75rem;">
                    <button type="button" id="import-btn" class="btn btn-primary" style="flex: 1;" onclick="executeImport()">
                        <i data-lucide="download" class="btn-icon"></i>
                        <span class="btn-text">Import Data</span>
                        <div class="spinner btn-spinner" style="display: none;"></div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="checkForImportFiles()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh
                    </button>
                </div>

                <!-- Error display -->
                <div id="import-error" class="alert alert-error" style="display: none; margin-top: 1rem;">
                    <i data-lucide="alert-circle"></i>
                    <span id="import-error-message"></span>
                </div>

                <!-- Success display -->
                <div id="import-success" class="alert alert-success" style="display: none; margin-top: 1rem;">
                    <i data-lucide="check-circle"></i>
                    <span id="import-success-message"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Previously Imported -->
{% if has_completed_import %}
<div class="card" style="margin-top: 1rem;">
    <div class="card-header">
        <i data-lucide="history"></i>
        <h2>Previous Imports</h2>
    </div>
    <div class="card-body">
        <p class="text-muted" style="font-size: 0.9rem;">
            Previously imported files are stored in <code>/config/import/completed/</code>
        </p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Check for import files on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkForImportFiles();
    });

    function checkForImportFiles() {
        const importChecking = document.getElementById('import-checking');
        const importFound = document.getElementById('import-found');
        const importNotFound = document.getElementById('import-not-found');
        const importError = document.getElementById('import-error');
        const importSuccess = document.getElementById('import-success');

        // Reset state
        importChecking.style.display = 'block';
        importFound.style.display = 'none';
        importNotFound.style.display = 'none';
        if (importError) importError.style.display = 'none';
        if (importSuccess) importSuccess.style.display = 'none';

        fetch('/setup/import/detect')
            .then(response => response.json())
            .then(data => {
                importChecking.style.display = 'none';

                if (data.has_import_files) {
                    importFound.style.display = 'block';

                    // Build summary
                    let summary = '';
                    if (data.has_settings) {
                        summary += '<div><i data-lucide="check" style="width: 16px; height: 16px; color: var(--plex-success); vertical-align: middle; margin-right: 0.5rem;"></i>Settings file found</div>';
                    }
                    if (data.timestamps_count > 0) {
                        summary += `<div><i data-lucide="check" style="width: 16px; height: 16px; color: var(--plex-success); vertical-align: middle; margin-right: 0.5rem;"></i>${data.timestamps_count} cached file timestamps</div>`;
                    }
                    if (data.ondeck_count > 0) {
                        summary += `<div><i data-lucide="check" style="width: 16px; height: 16px; color: var(--plex-success); vertical-align: middle; margin-right: 0.5rem;"></i>${data.ondeck_count} OnDeck items</div>`;
                    }
                    if (data.watchlist_count > 0) {
                        summary += `<div><i data-lucide="check" style="width: 16px; height: 16px; color: var(--plex-success); vertical-align: middle; margin-right: 0.5rem;"></i>${data.watchlist_count} Watchlist items</div>`;
                    }
                    if (!data.has_settings && data.timestamps_count === 0 && data.ondeck_count === 0 && data.watchlist_count === 0) {
                        summary = '<div class="text-muted">Import folder exists but no recognizable files found</div>';
                    }

                    document.getElementById('import-summary').innerHTML = summary;
                    lucide.createIcons();

                    // Set detected cache prefix if available
                    if (data.detected_cache_prefix) {
                        document.getElementById('cli_cache_prefix').value = data.detected_cache_prefix;
                    }
                } else {
                    importNotFound.style.display = 'block';
                }

                lucide.createIcons();
            })
            .catch(err => {
                console.error('Import detection error:', err);
                importChecking.style.display = 'none';
                importNotFound.style.display = 'block';
                lucide.createIcons();
            });
    }

    function executeImport() {
        const importBtn = document.getElementById('import-btn');
        const btnText = importBtn.querySelector('.btn-text');
        const btnIcon = importBtn.querySelector('.btn-icon');
        const btnSpinner = importBtn.querySelector('.btn-spinner');
        const errorDiv = document.getElementById('import-error');
        const errorMsg = document.getElementById('import-error-message');
        const successDiv = document.getElementById('import-success');
        const successMsg = document.getElementById('import-success-message');

        // Show loading state
        btnText.textContent = 'Importing...';
        btnIcon.style.display = 'none';
        btnSpinner.style.display = 'block';
        importBtn.disabled = true;
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        const formData = new FormData();
        formData.append('cli_cache_prefix', document.getElementById('cli_cache_prefix').value);
        formData.append('docker_cache_prefix', document.getElementById('docker_cache_prefix').value);

        fetch('/setup/import/execute', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            btnText.textContent = 'Import Data';
            btnIcon.style.display = 'inline';
            btnSpinner.style.display = 'none';
            importBtn.disabled = false;

            if (data.success) {
                successMsg.textContent = data.message + '. Refreshing page...';
                successDiv.style.display = 'flex';
                lucide.createIcons();

                // Refresh after a moment to show updated state
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                errorMsg.textContent = data.message || 'Import failed';
                errorDiv.style.display = 'flex';
                lucide.createIcons();
            }
        })
        .catch(err => {
            btnText.textContent = 'Import Data';
            btnIcon.style.display = 'inline';
            btnSpinner.style.display = 'none';
            importBtn.disabled = false;
            errorMsg.textContent = 'Network error: ' + err.message;
            errorDiv.style.display = 'flex';
            lucide.createIcons();
        });
    }
</script>
{% endblock %}
